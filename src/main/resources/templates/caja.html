<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Caja</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .btn-producto {
            display: block;
            width: 100%;
            text-align: left;
        }
    </style>
</head>
<body class="bg-gray-100">
<div class="container mx-auto py-8 px-4">
    <h1 class="text-3xl font-bold mb-8">Caja</h1>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="overflow-hidden rounded-lg border border-gray-200">
            <h2 class="text-xl font-semibold bg-gray-200 py-3 px-6">Productos Seleccionados</h2>
            <div class="p-6">
                <div id="productos-seleccionados" class="mt-4 overflow-y-auto max-h-80">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Producto</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Unitario</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subtotal</th>
                        </tr>
                        </thead>
                        <tbody id="tabla-productos-seleccionados">
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 text-right">
                    <span class="text-lg font-semibold">Total: $<span id="total-venta">0.00</span></span>
                </div>
            </div>
        </div>
        <div>
            <div class="flex flex-wrap space-x-2">
                <button class="bg-blue-500 text-white rounded-lg py-2 px-4 hover:bg-blue-600 transition duration-300" data-categoria="Cortes de Cerdo">Cortes de Cerdo</button>
                <button class="bg-blue-500 text-white rounded-lg py-2 px-4 hover:bg-blue-600 transition duration-300" data-categoria="Cortes de Ternera">Cortes de Ternera</button>
                <button class="bg-blue-500 text-white rounded-lg py-2 px-4 hover:bg-blue-600 transition duration-300" data-categoria="Pollo">Pollo</button>
                <button class="bg-blue-500 text-white rounded-lg py-2 px-4 hover:bg-blue-600 transition duration-300" data-categoria="Mercadería">Mercadería</button>
                <button class="bg-blue-500 text-white rounded-lg py-2 px-4 hover:bg-blue-600 transition duration-300" data-categoria="Insumos">Insumos</button>
                <button class="bg-blue-500 text-white rounded-lg py-2 px-4 hover:bg-blue-600 transition duration-300" data-categoria="Bultos">Bultos</button>
            </div>
            <h2 class="text-xl font-semibold mb-4">Productos</h2>
            <div id="productos" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
    </div>
    
    <!-- Botones para Método de Pago -->
    <div class="mt-4">
        <h2 class="text-xl font-semibold mb-2">Método de Pago</h2>
        <div class="flex space-x-4">
            <button class="bg-green-500 text-white rounded-lg py-2 px-4 hover:bg-green-600 transition duration-300" onclick="seleccionarMetodoPago('EFECTIVO')">Efectivo</button>
            <button class="bg-green-500 text-white rounded-lg py-2 px-4 hover:bg-green-600 transition duration-300" onclick="seleccionarMetodoPago('TARJETA')">Tarjeta</button>
        </div>
        <div id="campo-monto-pagado" class="mt-4 hidden">
            <label for="monto-pagado" class="block text-lg font-medium text-gray-700">Monto Pagado:</label>
            <input type="number" id="monto-pagado" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="Ingrese el monto pagado">
        </div>
        <div id="campo-vuelto" class="mt-4 hidden">
            <span class="text-lg font-semibold">Vuelto: $<span id="vuelto"></span></span>
        </div>
    </div>
    
    <div class="mt-8">
        <button id="btn-registrar-venta" class="bg-blue-500 text-white rounded-lg py-2 px-4 hover:bg-blue-600 transition duration-300">Registrar Venta</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    let productosSeleccionados = [];
    let metodoPago = '';

    document.querySelectorAll('button[data-categoria]').forEach(button => {
        button.addEventListener('click', () => {
            const categoria = button.getAttribute('data-categoria');
            cargarProductosPorCategoria(categoria);
        });
    });

    document.getElementById('btn-registrar-venta').addEventListener('click', () => {
        registrarVenta();
    });

    function cargarProductosPorCategoria(categoria) {
        axios.get(`/productos/categoria/${categoria}`)
            .then(response => {
                mostrarProductos(response.data);
            });
    }

    function mostrarProductos(productos) {
        const contenedorProductos = document.getElementById('productos');
        contenedorProductos.innerHTML = '';

        productos.forEach(producto => {
            const productoBtn = document.createElement('button');
            productoBtn.classList.add('bg-gray-300', 'rounded-lg', 'py-2', 'px-4', 'hover:bg-gray-400', 'transition', 'duration-300', 'btn-producto');
            productoBtn.textContent = `${producto.nombre} - $${producto.precio}`;
            productoBtn.addEventListener('click', () => {
                agregarProductoSeleccionado(producto);
            });
            contenedorProductos.appendChild(productoBtn);
        });
    }

    function agregarProductoSeleccionado(producto) {
        const detalleVenta = {
            producto: { id: producto.id },
            nombreProducto: producto.nombre,
            precioUnitario: producto.precio,
            cantidad: 1,
            subtotal: producto.precio
        };

        productosSeleccionados.push(detalleVenta);
        actualizarTablaProductosSeleccionados();
    }

    function actualizarTablaProductosSeleccionados() {
        const tablaProductos = document.getElementById('tabla-productos-seleccionados');
        tablaProductos.innerHTML = '';

        let total = 0;

        productosSeleccionados.forEach(detalle => {
            total += detalle.subtotal;

            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${detalle.nombreProducto}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${detalle.descripcion}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${detalle.precioUnitario}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${detalle.cantidad}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${detalle.subtotal}</td>
            `;
            tablaProductos.appendChild(fila);
        });

        document.getElementById('total-venta').textContent = total.toFixed(2);
    }

    function seleccionarMetodoPago(metodo) {
        metodoPago = metodo;
        if (metodo === 'EFECTIVO') {
            document.getElementById('campo-monto-pagado').classList.remove('hidden');
            document.getElementById('campo-vuelto').classList.remove('hidden');
        } else {
            document.getElementById('campo-monto-pagado').classList.add('hidden');
            document.getElementById('campo-vuelto').classList.add('hidden');
        }
    }

    function calcularVuelto(montoPagado, total) {
        return montoPagado - total;
    }

    function registrarVenta() {
        const totalVenta = productosSeleccionados.reduce((total, detalle) => total + detalle.subtotal, 0);
        const montoPagado = parseFloat(document.getElementById('monto-pagado').value) || 0;
        const vuelto = calcularVuelto(montoPagado, totalVenta);

        const venta = {
            detallesVenta: productosSeleccionados,
            metodoPago: metodoPago,
            total: totalVenta,
            montoPagado: metodoPago === 'EFECTIVO' ? montoPagado : 0,
            vuelto: metodoPago === 'EFECTIVO' ? vuelto : 0
        };

        axios.post('/ventas', venta)
            .then(response => {
                alert(response.data);
                productosSeleccionados = [];
                actualizarTablaProductosSeleccionados();
                document.getElementById('total-venta').textContent = '0.00';
                document.getElementById('monto-pagado').value = '';
                document.getElementById('vuelto').textContent = '';
            })
            .catch(error => {
                console.error(error);
                alert('Error al registrar la venta.');
            });
    }

    document.getElementById('monto-pagado').addEventListener('input', () => {
        const totalVenta = parseFloat(document.getElementById('total-venta').textContent);
        const montoPagado = parseFloat(document.getElementById('monto-pagado').value) || 0;
        const vuelto = calcularVuelto(montoPagado, totalVenta);
        document.getElementById('vuelto').textContent = vuelto.toFixed(2);
    });
</script>
</body>
</html>
